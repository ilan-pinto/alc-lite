# Intraday 5-minute Historical Bars Collection Configuration
# Optimized for laptop-based collection from Israel timezone
# Created: 2025-08-12

# Timezone configuration
timezone: Asia/Jerusalem

# Multiple collection windows for laptop availability
collection_windows:
  morning_snapshot:
    enabled: true
    time_et: "10:00"
    time_israel_winter: "17:00"  # 5 PM IST
    time_israel_summer: "18:00"  # 6 PM IDT
    duration_to_collect: "30 mins"
    priority: "high"
    purpose: "Capture opening volatility and early trends"

  midday_collection:
    enabled: true
    time_et: "12:30"
    time_israel_winter: "19:30"  # 7:30 PM IST
    time_israel_summer: "20:30"  # 8:30 PM IDT
    duration_to_collect: "3 hours"
    priority: "medium"
    purpose: "Collect morning session data"

  afternoon_update:
    enabled: false  # Optional - enable if laptop available
    time_et: "14:30"
    time_israel_winter: "21:30"  # 9:30 PM IST
    time_israel_summer: "22:30"  # 10:30 PM IDT
    duration_to_collect: "5 hours"
    priority: "low"
    purpose: "Mid-afternoon data update"

  market_close:
    enabled: true
    time_et: "16:45"
    time_israel_winter: "23:45"  # 11:45 PM IST
    time_israel_summer: "00:45"  # 12:45 AM IDT (next day)
    duration_to_collect: "1 D"
    priority: "critical"
    purpose: "Primary full-day collection including close"

  late_night_backfill:
    enabled: true
    time_israel: "01:00"  # 1 AM Israel time (both winter/summer)
    duration_to_collect: "1 D"
    priority: "high"
    purpose: "Ensure complete data coverage and fill any gaps"

# Rate limiting configuration for IB API compliance (Single Connection with Greeks)
rate_limits:
  max_requests_per_second: 0.033  # Conservative: 1 request per 30 seconds (Greeks doubles requests)
  parallel_connections: 1  # Single connection only
  client_ids: [1]  # Single client ID for stability
  batch_size_per_connection: 1  # Process contracts one at a time
  pause_between_batches_seconds: 3  # Longer pause between contracts due to Greeks collection

  # Pacing violation recovery
  pacing_violation_wait_seconds: 60
  max_retry_attempts: 5  # More retries for single connection
  exponential_backoff: true

  # Connection stability settings
  connection_timeout_seconds: 45  # Longer timeout for connection
  connection_retry_delay: 10  # Wait between connection attempts
  single_connection_mode: true

# Collection parameters
collection_params:
  bar_size: "5 mins"
  collect_greeks: true  # Enable Greeks and IV collection (doubles API requests)
  collect_stock_data: true  # Enable stock/underlying data collection
  data_types:
    primary: "TRADES"  # Primary data source for OHLCV
    secondary: "BID_ASK"  # Fallback if TRADES unavailable
    greeks: "OPTION_IMPLIED_VOLATILITY"  # For Greeks and IV collection
    stock: "TRADES"  # Stock data source
  use_rth: true  # Regular trading hours only (9:30 AM - 4:00 PM ET)
  max_duration_per_request: "2 D"  # Optimize for less data transfer
  include_expired: false  # Don't collect expired options

  # Contract filtering
  expiry_range_days: 60  # Only collect options expiring within 60 days
  strike_range_percent: 0.20  # Collect strikes within Â±20% of current price
  min_volume_filter: 0  # No minimum volume requirement for Phase 1
  min_open_interest_filter: 0  # No minimum OI requirement for Phase 1

# Smart collection features
smart_features:
  gap_detection: true  # Automatically detect missing bars
  incremental_updates: true  # Only request data not already in database
  deduplication: true  # Handle overlapping requests gracefully
  compression_after_days: 7  # Compress data older than 7 days
  archive_after_days: 30  # Archive to cold storage after 30 days

  # Intelligent retry
  retry_on_no_data: false  # Don't retry if IB returns no data
  retry_on_error: true  # Retry on connection/API errors
  skip_weekends: true  # Don't attempt collection on weekends
  skip_holidays: true  # Skip US market holidays

# Database configuration
database:
  host: localhost
  port: 5433  # TimescaleDB port
  database: options_arbitrage
  user: trading_user
  password: secure_trading_password
  pool_size: 10

  # Batch operations
  insert_batch_size: 100
  use_copy_from: true  # Use COPY for bulk inserts

# IB Gateway configuration (Optimized for Single Connection)
ib_gateway:
  host: 127.0.0.1
  port: 7497  # Paper trading port
  timeout_seconds: 45  # Longer timeout for stability
  reconnect_attempts: 5  # More retry attempts
  reconnect_delay_seconds: 15  # Shorter delay between retries

  # Connection health
  heartbeat_interval_seconds: 30  # More frequent heartbeat
  max_idle_seconds: 180  # Shorter idle timeout

  # Single connection optimizations
  enable_logging: true
  validate_connection: true
  warmup_delay_seconds: 5

# Logging configuration
logging:
  level: INFO
  file_path: logs/historical_bars_collector.log
  max_file_size_mb: 100
  backup_count: 7
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

  # Separate logs for different aspects
  error_file_path: logs/historical_collector_error.log
  metrics_file_path: logs/collection_metrics.log
  rate_limit_file_path: logs/rate_limit_events.log

# Monitoring and alerting
monitoring:
  track_collection_stats: true
  alert_on_gaps: true
  min_bars_per_day: 78  # 6.5 hours * 12 bars/hour
  max_acceptable_gap_minutes: 15

  # Data quality thresholds
  min_completeness_percent: 90  # Alert if less than 90% data collected
  max_stale_data_hours: 24  # Alert if data older than 24 hours

  # Performance monitoring
  track_request_times: true
  alert_on_slow_requests: true
  max_request_time_seconds: 30

  # Storage monitoring
  track_storage_usage: true
  alert_on_low_space: true
  min_free_space_gb: 10

# Symbols configuration for Phase 1
symbols:
  primary:
    - SPY  # S&P 500 ETF - highest liquidity
    - PLTR  # Palantir - good volatility
    - TSLA  # Tesla - high volume options

  # Additional symbols for future phases
  secondary:
    - QQQ  # NASDAQ ETF
    - IWM  # Russell 2000 ETF
    - META  # Meta/Facebook
    - NVDA  # Nvidia
    - AAPL  # Apple

  # Test symbols for development
  test:
    - SPY  # Use SPY for testing due to liquidity

# Phase 1 specific settings
phase1:
  test_mode: false  # Set to true for dry run
  dry_run: false  # Don't write to database if true
  verbose_logging: true  # Extra logging for debugging
  save_debug_snapshots: true  # Save raw responses for debugging
  debug_snapshot_path: logs/debug_snapshots/

  # Collection limits for Phase 1
  max_contracts_per_symbol: 200  # Limit contracts to manage collection time
  max_daily_collection_runs: 10  # Prevent excessive runs

  # Success criteria tracking
  track_metrics: true
  metrics_report_daily: true
  target_completeness_percent: 95
  target_uptime_percent: 98

# Backfill configuration
backfill:
  enabled: true
  max_days_to_backfill: 7  # Only backfill last 7 days
  backfill_on_gaps: true  # Automatically backfill detected gaps
  backfill_time: "02:00"  # 2 AM Israel time
  backfill_batch_size: 50  # Contracts per backfill batch

  # Prioritization
  prioritize_near_expiry: true  # Collect near-expiry options first
  prioritize_high_volume: true  # Collect high-volume strikes first
